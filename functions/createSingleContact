import { createClientFromRequest } from 'npm:@base44/sdk@0.5.0';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        if (!(await base44.auth.isAuthenticated())) {
            return new Response(JSON.stringify({ success: false, error: 'Unauthorized' }), {
                status: 401,
                headers: { 'Content-Type': 'application/json' }
            });
        }
        const user = await base44.auth.me();
        if (!user?.company_id) {
            return new Response(JSON.stringify({ success: false, error: 'No company found' }), {
                status: 400,
                headers: { 'Content-Type': 'application/json' }
            });
        }

        // --- VERIFICAÇÃO DE LIMITE DO PLANO ---
        const subscriptions = await base44.asServiceRole.entities.SubscriptionsStripe.filter({
            company_id: user.company_id,
            status: 'active'
        });

        if (subscriptions.length > 0) {
            const activeSubscription = subscriptions[0];
            const planId = activeSubscription.metadata?.plan_id;
            if (planId) {
                const currentPlan = await base44.asServiceRole.entities.Plan.get(planId);
                if (currentPlan) {
                    const contactLimit = currentPlan.active_contacts;
                    if (contactLimit !== -1) {
                        const allContacts = await base44.entities.Contact.filter({ company_id: user.company_id });
                        if (allContacts.length >= contactLimit) {
                            return new Response(JSON.stringify({
                                success: false,
                                error: `Limite de ${contactLimit} contatos atingido. Para adicionar mais, faça um upgrade no seu plano.`
                            }), {
                                status: 403,
                                headers: { 'Content-Type': 'application/json' }
                            });
                        }
                    }
                }
            }
        }
        // --- FIM DA VERIFICAÇÃO ---

        const { contactData } = await req.json();

        if (!contactData || !contactData.first_name || !contactData.phone) {
            return new Response(JSON.stringify({ success: false, error: 'First name and phone are required' }), {
                status: 400,
                headers: { 'Content-Type': 'application/json' }
            });
        }

        const newContact = {
            ...contactData,
            company_id: user.company_id,
            created_by: user.id
        };

        const createdContact = await base44.entities.Contact.create(newContact);

        return new Response(JSON.stringify({ success: true, data: createdContact }), {
            status: 201,
            headers: { 'Content-Type': 'application/json' }
        });
    } catch (error) {
        console.error('Create single contact error:', error);
        return new Response(JSON.stringify({ success: false, error: 'Internal server error', details: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
        });
    }
});